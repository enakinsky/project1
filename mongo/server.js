require('dotenv').config();
const express = require('express');
const mongoose = require('mongoose');
const cors = require('cors');
const Booking = require('./models/Booking');

const app = express();
const PORT = process.env.PORT || 3000;

// Middleware
app.use(cors()); // Ð Ð°Ð·Ñ€ÐµÑˆÐ°ÐµÐ¼ Ð·Ð°Ð¿Ñ€Ð¾ÑÑ‹ Ñ Ñ„Ñ€Ð¾Ð½Ñ‚ÐµÐ½Ð´Ð°
app.use(express.json()); // ÐŸÐ°Ñ€ÑÐ¸Ð¼ JSON-Ñ‚ÐµÐ»Ð° Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð²

// ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ðº MongoDB Atlas
mongoose.connect(process.env.MONGODB_URI)
  .then(() => console.log('âœ… ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¾ Ðº MongoDB Atlas'))
  .catch(err => console.error('âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ:', err));

// Ð Ð¾ÑƒÑ‚Ñ‹
// 1. Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ Ð±Ñ€Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ
app.post('/api/bookings', async (req, res) => {
  try {
    const { name, phone, email, tour, date } = req.body;

    // Ð’Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ñ (Ð¼Ð¾Ð¶Ð½Ð¾ Ð´Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ Ð±Ð¾Ð»ÑŒÑˆÐµ Ð¿Ñ€Ð¾Ð²ÐµÑ€Ð¾Ðº)
    if (!name || !phone || !tour) {
      return res.status(400).json({ error: 'Ð—Ð°Ð¿Ð¾Ð»Ð½Ð¸Ñ‚Ðµ Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð¿Ð¾Ð»Ñ' });
    }

    const booking = new Booking({
      name,
      phone,
      email,
      tour,
      date: date || new Date() // Ð•ÑÐ»Ð¸ Ð´Ð°Ñ‚Ð° Ð½Ðµ ÑƒÐºÐ°Ð·Ð°Ð½Ð°, Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ñ‚ÐµÐºÑƒÑ‰ÑƒÑŽ
    });

    await booking.save();
    console.log('ðŸ“Œ Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¾ Ð±Ñ€Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ:', booking);
    res.status(201).json({ message: 'Ð‘Ñ€Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ ÑÐ¾Ð·Ð´Ð°Ð½Ð¾!', booking });
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});

// 2. ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ð²ÑÐµÑ… Ð±Ñ€Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ð¹ (Ð´Ð»Ñ Ð°Ð´Ð¼Ð¸Ð½ÐºÐ¸)
app.get('/api/bookings', async (req, res) => {
  try {
    const bookings = await Booking.find().sort({ date: -1 }); // Ð¡Ð¾Ñ€Ñ‚Ð¸Ñ€Ð¾Ð²ÐºÐ° Ð¿Ð¾ Ð´Ð°Ñ‚Ðµ (Ð½Ð¾Ð²Ñ‹Ðµ ÑÐ½Ð°Ñ‡Ð°Ð»Ð°)
    res.json(bookings);
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});

// 3. Ð£Ð´Ð°Ð»ÐµÐ½Ð¸Ðµ Ð±Ñ€Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ (Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾)
app.delete('/api/bookings/:id', async (req, res) => {
  try {
    const booking = await Booking.findByIdAndDelete(req.params.id);
    if (!booking) {
      return res.status(404).json({ error: 'Ð‘Ñ€Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾' });
    }
    res.json({ message: 'Ð‘Ñ€Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¾', booking });
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});

// Ð¡Ñ‚Ð°Ñ‚Ð¸ÐºÐ° Ð´Ð»Ñ Ñ„Ñ€Ð¾Ð½Ñ‚ÐµÐ½Ð´Ð° (ÐµÑÐ»Ð¸ Ñ„Ñ€Ð¾Ð½Ñ‚ Ð¸ Ð±ÑÐº Ð½Ð° Ð¾Ð´Ð½Ð¾Ð¼ ÑÐµÑ€Ð²ÐµÑ€Ðµ)
app.use(express.static('public'));

// Ð—Ð°Ð¿ÑƒÑÐº ÑÐµÑ€Ð²ÐµÑ€Ð°
app.listen(PORT, () => {
  console.log(`ðŸš€ Ð¡ÐµÑ€Ð²ÐµÑ€ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ð½Ð° http://localhost:${PORT}`);
});
